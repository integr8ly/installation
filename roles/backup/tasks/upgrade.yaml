---
- name: check if backup alerts are installed
  shell: "oc get prometheusrule backup-monitoring-alerts -n {{ monitoring_namespace }}"
  register: check_alerts

- name: read alert template
  template:
    src: alert-failing-jobs.yml.j2
    dest: /tmp/alert-failing-jobs.yml
  when: check_alerts.rc == 0

- name: add alert for failing cronjobs
  shell: "oc patch prometheusrule backup-monitoring-alerts --type=json --patch='[{\"op\": \"add\", \"path\": \"/spec/groups/0/rules\", \"value\": \"{{ lookup('file', '/tmp/alert-failing-jobs.yml') }} \"}]' -n {{ monitoring_namespace }}"
  when: check_alerts.rc == 0

- debug:
    msg: "Backup monitoring alerts are not installed"
  when: check_alerts.rc != 0