---
- name: Read master config
  slurp:
    src: "{{ webapp_openshift_master_config_path }}"
  register: masterconf
  become: yes

- name: Add webapp route to corsAllowedOrigins in master config, matching indentation of existing items
  blockinfile:
    marker: "# {mark} GENERATED BY WEBAPP INSTALLER"
    path: "{{ webapp_openshift_master_config_path }}"
    insertafter: "corsAllowedOrigins"
    backup: yes
    block: >
      {{ masterconf['content'] | b64decode
      | regex_replace('(?m)^[ \t]*#.+\n', '') 
      | regex_search('(?<=corsAllowedOrigins:\n)([ \t]*)') 
      }}- https://{{ hostvars['WEBAPP_VARS']['webapp_secure_route'] }}
  register: webapp_master_config_update
  become: yes
