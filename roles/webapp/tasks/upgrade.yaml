---
- name: Bump the Web App operator version to {{ webapp_operator_release_tag }}
  shell: oc patch deployment tutorial-web-app-operator -n {{ eval_webapp_namespace }} --type json -p '[{"op":"replace", "path":"/spec/template/spec/containers/0/image", "value":"{{ upgrade_webapp_operator_image }}"}]'
  register: upgrade_webapp_operator
  failed_when: upgrade_webapp_operator.stderr != '' and 'not patched' not in upgrade_webapp_operator.stderr

#- name: Bump the Web App deployment version to {{ webapp_version }}
#  shell: oc patch dc tutorial-web-app -n {{ eval_webapp_namespace }} --type json -p '[{"op":"replace", "path":"/spec/template/spec/containers/0/image", "value":"{{ upgrade_webapp_image }}"}]'
#  register: upgrade_webapp
#  failed_when: upgrade_webapp.stderr != '' and 'not patched' not in upgrade_webapp.stderr

- name: Generate WebApp custom resource template
  template:
    src: "cr.yaml.j2"
    dest: /tmp/webapp-cr.yml

- name: Apply WebApp custom resource
  shell: oc apply -f /tmp/webapp-cr.yml -n {{ webapp_namespace }}
  register: apply_webapp_custom_resource_cmd
  failed_when: apply_webapp_custom_resource_cmd.stderr != '' and 'Warning' not in apply_webapp_custom_resource_cmd.stderr
  changed_when: apply_webapp_custom_resource_cmd.rc == 0
