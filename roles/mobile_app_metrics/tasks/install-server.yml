---
- include_tasks: backup.yml

- name: Process mobile-app-metrics server template
  template:
    src: mobile-app-metrics.yml.j2
    dest: "{{ mobile_app_metrics_template_dir }}/mobile-app-metrics.yml"

- name: Apply mobile-app-metrics server resource
  shell: "oc create -f {{ mobile_app_metrics_template_dir }}/mobile-app-metrics.yml -n {{ mobile_app_metrics_namespace }}"
  register: output
  failed_when: output.stderr != '' and 'AlreadyExists' not in output.stderr

- name: Wait for mobile-app-metrics readiness
  shell: "oc get appmetricsservice/{{ mobile_app_metrics_server_name }} -o jsonpath='{.status.phase}' -n {{ mobile_app_metrics_namespace }}"
  register: result
  until: result.stdout == 'Complete'
  retries: 50
  delay: 10
  failed_when: result.stderr
  changed_when: False