- name: Upgrade AlertManager
  block:
  - name: Set smtp_auth_password
    shell: oc get secret alertmanager-application-monitoring -n openshift-middleware-monitoring --template='{{index .data "alertmanager.yaml"}}' | base64 --decode | grep smtp_auth_password | awk '{print $2}'
    register: smtp_auth_password
 
  - name: Set dms_webhook_url
    shell: oc get secret alertmanager-application-monitoring -n openshift-middleware-monitoring --template='{{index .data "alertmanager.yaml"}}' | base64 --decode | grep nosnch | cut -d "\"" -f2
    register: dms_webhook_url 
  
  - name: Set pd_service_key
    shell: oc get secret alertmanager-application-monitoring -n openshift-middleware-monitoring --template='{{index .data "alertmanager.yaml"}}' | base64 --decode | grep service_key | cut -d ":" -f2 | cut -d " " -f2
    register: pd_service_key
    
  - name: Delete alertmanager-application-monitoring secret
    shell: oc delete --ignore-not-found secret alertmanager-application-monitoring -n middleware-monitoring

  # Recreate the secret
  - include_tasks: ./create_alertmanager.yml  

  # Delete the pod to force a re create and a re mount of the new secret
  - name: Restart the pod with new secret
    shell: oc delete --ignore-not-found pod alertmanager-application-monitoring-0 -n middleware-monitoring

  # Once any of these are present, update alertmanager secret
  when: smtp_auth_password != '' or
        dms_webhook_url != '' or
        pd_service_key != ''
