---
-
  name: Check master-config has been modified by the installer
  shell: "cat {{ rhsso_openshift_master_config_path }} | grep 'GENERATED BY SSO INSTALLER' | wc -l"
  become: yes
  register: output

-
  name: "rewrite master config and restart API"
  when: output.stdout != "0"
  block:
    - 
      name: Read original identity provider config backup
      shell: "cat {{ original_identityprovider_config_path }}"
      register: original_idp_config_backup
      failed_when: false
      become: yes
    - 
      debug:
        msg: "The backup file for the default identity provider configuration is empty or does not exist. Skipping default identity provider restoration."
      when: original_idp_config_backup.stdout == ""
    - 
      name: Remove modified identityProvider config
      shell: "sed -i.bak '/identityProviders/,/masterCA/{//!d}' {{ rhsso_openshift_master_config_path }}"
      args:
        warn: no
      when: original_idp_config_backup.stdout != "" 
      become: yes
    - 
      name: Restore original identity provider config
      blockinfile:
        marker: "# {mark} GENERATED BY SSO UNINSTALLER"
        path: "{{ rhsso_openshift_master_config_path }}"
        insertafter: "identityProviders"
        backup: yes
        block: "{{ original_idp_config_backup.stdout }}"
      become: yes
      when: original_idp_config_backup.stdout != ""
    -
      name: Restart master api
      become: yes
      shell: /usr/local/bin/master-restart api
    -
      name: Restart master controllers
      become: yes
      shell: /usr/local/bin/master-restart controllers
    -
      name: check if openshift master services are running
      shell: oc get nodes
      register: task_result
      until: task_result.rc == 0
      retries: 6
      delay: 5
      failed_when: task_result.rc != 0

# Delete users and identities created by rhsso
-
  name: "Get all users created by rhsso"
  shell: oc get users | grep 'rh_sso' | awk '{print $1}'
  register: users
  failed_when: false

-
  name: "Delete users"
  shell:  "oc delete users {{ users.stdout | replace('\n', ' ') }}"
  when: users.stdout != ''
  failed_when: false