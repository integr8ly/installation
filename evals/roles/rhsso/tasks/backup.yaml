---
-
  name: "check keycloak namespace exists"
  shell: "oc get project {{ rhsso_namespace }} | grep {{ rhsso_namespace }} | wc -l"
  register: "sso_namespace_exists"

- name: Create ServiceAccount and role binding
  include_role:
    name: backup
    tasks_from: _setup_service_account.yml
  vars:
    binding_name: rhsso-backup-binding
    serviceaccount_namespace: '{{ rhsso_namespace }}'

- name: Prepare role binding
  template:
    src: ../../backup/templates/backup-role-binding.yml.j2
    dest: /tmp/backup-role-binding.yml
  vars:
    name: rhsso-default-backup-binding
    serviceaccount_namespace: '{{ rhsso_namespace }}'

- name: Create backup role binding
  shell: oc create -f /tmp/backup-role-binding.yml -n {{ aws_s3_backup_secret_namespace }}
  register: backup_rolebinding_create
  failed_when: backup_rolebinding_create.stderr != '' and 'AlreadyExists' not in backup_rolebinding_create.stderr

-
  name: "Add backups to keycloak CR"
  when: sso_namespace_exists.stdout != "0"
  block:
    -
      name: "patch Keycloak CR"
      shell: oc patch keycloak rhsso -n {{ rhsso_namespace }} --patch '{"spec":{"backups":{{ rhsso_backups | to_json }}}}' --type=merge

