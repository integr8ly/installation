---
- name: Wait for user secrets to be created
  command: oc get secret {{ item }} -o json -n {{ rhsso_namespace }}
  register: user_secret
  until: user_secret.stderr == ""
  retries: 300
  delay: 5
  failed_when: user_secret.stderr != "" and user_secret.stderr.find("not found") == -1
  with_items:
    - "{{ rhsso_cluster_admin_secret }}"
    - "{{ rhsso_evals_secret }}"

- name: Get RH-SSO secure route
  local_action: command oc get route/sso -o template --template \{\{.spec.host\}\} -n {{ rhsso_namespace }}
  register: rhsso_secure_route

- set_fact:
    rhsso_route: "{{ rhsso_secure_route.stdout }}"

- name: Remove htpasswd identity provider from master config
  shell: "sed -i.bak '/- challenge: true/,/kind: HTPasswdPasswordIdentityProvider/d' {{ eval_openshift_master_config_path }}"
  when: rhsso_disable_htpasswd_identity_provider
  become: yes

- set_fact:
    rhsso_identity_provider_ca_cert_path: ""
  when: not (eval_self_signed_certs | bool)

- name: Add RH-SSO identity provider to master config
  blockinfile:
    marker: "# {mark} GENERATED BY SSO INSTALLER"
    path: "{{ eval_openshift_master_config_path }}"
    insertafter: "identityProviders"
    backup: yes
    block: |2
        - name: rh_sso
          challenge: false
          login: true
          mappingInfo: add
          provider:
            apiVersion: v1
            kind: OpenIDIdentityProvider
            clientID: {{ rhsso_client_id }}
            clientSecret: {{ rhsso_client_secret }}
            ca: {{ rhsso_identity_provider_ca_cert_path }}
            urls:
              authorize: https://{{ rhsso_route }}/auth/realms/{{ rhsso_realm }}/protocol/openid-connect/auth
              token: https://{{ rhsso_route }}/auth/realms/{{ rhsso_realm }}/protocol/openid-connect/token
              userInfo: https://{{ rhsso_route }}/auth/realms/{{ rhsso_realm }}/protocol/openid-connect/userinfo
            claims:
              id:
              - sub
              preferredUsername:
               - preferred_username
              name:
              - name
              email:
              - email
  register: sso_master_config_update
  become: yes


- name: restart openshift master services
  shell: "{{ rhsso_master_restart_shim_path }} {{ item }}"
  become: yes
  when: sso_master_config_update.changed or webapp_master_config_update is defined and webapp_master_config_update.changed
  with_items:
  - api
  - controllers