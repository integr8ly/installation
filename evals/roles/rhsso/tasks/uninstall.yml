---
- template:
    src: templates/original-sso-x509-template.json
    dest: /tmp/original-sso-x509-template.json
    mode: 0644
  
- name: "replace rh-sso template with original"
  shell:  oc replace -n openshift --force -f /tmp/original-sso-x509-template.json

- name: "Delete project namespace: {{ rhsso_namespace }}"
  shell: oc delete project {{ rhsso_namespace }}
  register: output
  failed_when: output.stderr != '' and 'not found' not in output.stderr
  changed_when: output.rc == 0
- 
  name: Remove RH-SSO identity provider from master config
  shell: "sed -i.bak '/# BEGIN GENERATED BY SSO INSTALLER/,/# END GENERATED BY SSO INSTALLER/d' {{ rhsso_openshift_master_config_path }}"
  become: yes

- name: Add htpasswd identity provider to master config
  blockinfile:
    marker: "# {mark} GENERATED BY SSO UNINSTALLER"
    path: "{{ rhsso_openshift_master_config_path }}"
    insertafter: "identityProviders"
    backup: yes
    block: |2
        - challenge: true
          name: htpasswd_auth
          login: true
          mappingMethod: claim
          provider:
            apiVersion: v1
            file: /etc/origin/master/htpasswd
            kind: HTPasswdPasswordIdentityProvider
  register: sso_master_config_update
  become: yes
- 
  name: Restart master api
  become: true
  shell: /usr/local/bin/master-restart api
- 
  name: Restart master controllers
  become: true
  shell: /usr/local/bin/master-restart controllers