---
- name: "Update latest RH-SSO image stream and templates"
  shell: oc replace -n openshift --force -f {{ rhsso_template_url }}/{{ item }}
  with_items:
    - "{{ rhsso_image_stream_filename }}"
    - "{{ rhsso_template_filename }}"
  when: rhsso_force_image_streams_update

- name: "Import image streams {{ rhsso_image_stream }}"
  shell: oc -n openshift import-image {{ rhsso_image_stream }}:{{ rhsso_image_stream_tag }}
  register: import_result
  until: import_result is succeeded
  retries: 10
  delay: 5
  failed_when: import_result is failed
  when: rhsso_force_image_streams_update

- name: "Create project namespace: {{ keycloak_operator_namespace }}"
  shell: kubectl create namespace {{ keycloak_operator_namespace }}
  register: output
  failed_when: output.stderr != '' and 'already exists' not in output.stderr
  changed_when: output.rc == 0

- name: Install operator
  command: kubectl create -f {{ item }} -n {{ keycloak_operator_namespace }}
  register: output
  failed_when: output.stderr != '' and 'already exists' not in output.stderr
  with_items:
    - "{{ keycloak_operator_rbac }}"
    - "{{ keycloak_operator_crd }}"
    - "{{ keycloak_operator_operator }}"

- name: Generate client template
  template:
    src: "integreatly-keycloak.yaml"
    dest: /tmp/integreatly-keycloak.yaml

- name: Deploy integreatly keycloak
  command: oc create -f /tmp/integreatly-keycloak.yaml -n {{ keycloak_operator_namespace }}
