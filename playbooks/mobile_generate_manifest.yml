- import_playbook: "./prerequisites.yml"
- import_playbook: "./openshift.yml"

- hosts: localhost
  tasks:
    - include_vars: ../roles/ups/defaults/main.yml
    - include_vars: ../roles/mdc/defaults/main.yml

    - name: Retrieve current manifest
      shell: "oc get secret/manifest -o jsonpath='{.data.generated_manifest}' -n {{ eval_webapp_namespace }}"
      register: webapp_secret_cmd

    - name: Decode webapp secret
      set_fact:
        webapp_manifest: "{{ webapp_secret_cmd.stdout | b64decode | from_json }}"

    - set_fact:
        mobile_components: []

    #unified push server(ups)
    - name: Unified Push Server
      block:
        - name: Get Unified Push Server route
          shell: oc get route/unifiedpush-unifiedpush-proxy  -o template --template \{\{.spec.host\}\} -n {{ eval_ups_namespace | default('unifiedpush') }}
          register: ups_route_cmd
        - set_fact:
            ups_route: "https://{{ups_route_cmd.stdout}}"
        - name: Set Unified Push Server component
          set_fact:
            ups_manifest:
              - name: Unified Push Server
                version: "{{ ups_release_tag }}"
                host: "{{ ups_route }}"
                mobile: true
                type: "push"
        - set_fact:
            mobile_components: "{{ mobile_components }} + {{ ups_manifest }}"
      when: ups | default(true) | bool
