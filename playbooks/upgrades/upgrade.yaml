---
- hosts: master
  gather_facts: no
  tasks:
    - include_role:
        name: openshift
        tasks_from: set_master_vars
      when: run_master_tasks | default(true) | bool

    - name: Remove CORS entry from OpenShift master config
      include_role:
        name: mdc
        tasks_from: uninstall-cors
      tags: ['mdc']
      when: run_master_tasks | default(true) | bool
    - name: Restart openshift master services
      shell: "/usr/local/bin/master-restart {{ item }}"
      become: yes
      with_items:
        - api
        - controllers
      when: run_master_tasks | default(true) | bool
    - name: Check if openshift master services are running
      shell: oc get nodes
      register: task_result
      until: task_result.rc == 0
      retries: 6
      delay: 5
      failed_when: task_result.rc != 0
      when: run_master_tasks | default(true) | bool


# Required for Ansible Tower installs that need to login via oc as a prerequisite
- import_playbook: "../openshift.yml"
- import_playbook: "../install_heimdall.yml"

- hosts: localhost
  gather_facts: yes
  tasks:
    - include_role:
        name: prerequisites
        tasks_from: upgrade
      vars:
        from_versions:
          - "release-1.6.0"

#Update product version (should always be last)
- import_playbook: "../generate-customisation-inventory.yml"
