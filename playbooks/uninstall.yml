---
- hosts: localhost
  tasks:
    - when: create_cluster_admin
      name: switch to system:admin for uninstall
      shell: oc login -u system:admin
      register: oc_login
      failed_when: oc_login.rc != 0
    - when: keep_namespaces is undefined or not keep_namespaces | bool
      block:
      - name: Check that jq exists
        stat:
          path: /usr/bin/jq
        failed_when: false
        register: jq_binary
      - name: download jq
        become: true
        get_url:
          url: https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64
          dest: /usr/bin/jq
          mode: 0555
        when: jq_binary.stat.exists == False

      - name: Get namespaces to clean up
        shell: oc get namespaces -o json | jq '.items[] | select(.metadata.annotations["openshift.io/requester"] != null and .metadata.annotations["openshift.io/requester"] != "system:admin" and .metadata.labels["integreatly-middleware-service"] != "true") | .metadata.name' | cut -f2 -d'"'
        register: namespaces_output
      - name: Delete namespaces
        shell: "oc delete namespace {{ item }}"
        register: output
        failed_when: output.stderr != '' and 'not found' not in output.stderr and 'The system is ensuring all content is removed from this namespace.' not in output.stderr
        changed_when: output.rc == 0
        with_items: "{{ namespaces_output.stdout_lines }}"
    -
      name: Uninstall apicurito
      include_role:
        name: apicurito
        tasks_from: uninstall
      tags: ['apicurito']
      when: apicurito
    -
      name: Uninstall launcher
      include_role:
        name: launcher
        tasks_from: uninstall
      tags: ['launcher']
      when: launcher
    -
      name: Uninstall managed services broker
      include_role:
        name: msbroker
        tasks_from: uninstall
      tags: ['msbroker']
    -
      name: Uninstall 3scale
      include_role:
        name: 3scale
        tasks_from: uninstall
      tags: ['3scale']
      when: threescale
    -
      name: Uninstall Gitea
      include_role:
        name: gitea
        tasks_from: uninstall
      tags: ['gitea']
    -
      name: Uninstall enmasse
      include_role:
        name: enmasse
        tasks_from: uninstall
      tags: ['enmasse']
      when: enmasse
    -
      name: Uninstall the webapp
      include_role:
        name: webapp
        tasks_from: uninstall
      tags: ['webapp']
      when: webapp
    -
      name: Uninstall rhsso
      include_role:
        name: rhsso
        tasks_from: uninstall
      tags: ['rhsso']
    -
      name: Uninstall Nexus
      include_role:
        name: nexus
        tasks_from: uninstall
      tags: ['nexus']
      when: nexus
    -
      name: Uninstall Fuse
      include_role:
        name: fuse
        tasks_from: uninstall
      tags: ['fuse']
      when: fuse
    -
      name: Uninstall Walkthrough Apps
      include_role:
        name: walkthroughs
        tasks_from: uninstall
      tags: ['walkthroughs']
    -
      name: Uninstall kube_state_metrics
      include_role:
        name: kube_state_metrics
        tasks_from: uninstall
      tags: ['kube-state-metrics']
      when: kube_state_metrics | default(true) | bool
    -
      name: Uninstall middleware-monitoring
      include_role:
        name: middleware_monitoring
        tasks_from: uninstall
      tags: ['middleware-monitoring']
      when: middleware_monitoring | default(true) | bool
    -
      name: Reboot template broker
      include_role:
        name: reboot_template_broker
- hosts: master
  tasks:
    -
      name: Remove webapp cors data
      include_role:
        name: webapp
        tasks_from: cors-remove
      tags: ['webapp']
    -
      name: Uninstall rhsso
      include_role:
        name: rhsso
        tasks_from: remove_identityprovider
      tags: ['rhsso']
